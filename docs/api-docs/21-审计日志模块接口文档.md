# 审计日志模块 - 后端API接口文档

## 基础信息
- **模块名称**: 审计日志
- **模块路径**: `/api/v1/audit-logs`
- **负责功能**: 系统操作日志记录、查询、导出

---

## 接口列表

### 1. 获取审计日志统计
**接口地址**: `GET /api/v1/audit-logs/stats`

**查询参数**:
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "period": {
      "startDate": "2025-12-12",
      "endDate": "2025-12-19"
    },
    "totalLogs": 125000,
    "byLevel": {
      "info": 100000,
      "warning": 20000,
      "error": 5000
    },
    "byModule": {
      "users": 45000,
      "tenants": 25000,
      "permissions": 18000,
      "applications": 15000,
      "other": 22000
    },
    "topUsers": [
      {
        "userId": "U001",
        "userName": "张三",
        "operationCount": 5600
      },
      {
        "userId": "U002",
        "userName": "李四",
        "operationCount": 4800
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 2. 获取审计日志列表（分页）
**接口地址**: `GET /api/v1/audit-logs`

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认20
- `keyword`: 搜索关键词（操作描述）
- `userId`: 操作人ID筛选
- `module`: 模块筛选（users、tenants、permissions等）
- `operation`: 操作类型（create、update、delete、query等）
- `level`: 日志级别（info、warning、error）
- `ipAddress`: IP地址筛选
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "total": "125000",
    "list": [
      {
        "tenantId": "1",
        "createdBy": "1000001",
        "creator": "张三",
        "createdDate": "2025-12-19 10:30:00",
        "modifiedBy": "1000001",
        "modifier": "张三",
        "modifiedDate": "2025-12-19 10:30:00",
        "id": "LOG_001",
        "userId": "U001",
        "userName": "张三",
        "module": "users",
        "moduleName": "用户管理",
        "operation": "create",
        "operationName": "创建用户",
        "description": "创建了新用户：李四（lisi@example.com）",
        "level": "info",
        "ipAddress": "192.168.1.100",
        "location": "北京",
        "device": "Chrome 120 on Windows 10",
        "operationTime": "2025-12-19 10:30:00",
        "duration": 125,
        "success": true,
        "requestData": {
          "name": "李四",
          "email": "lisi@example.com"
        },
        "responseData": {
          "id": "U100",
          "status": "success"
        }
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 3. 获取审计日志详情
**接口地址**: `GET /api/v1/audit-logs/{id}`

**路径参数**:
- `id`: 日志ID

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "id": "LOG_001",
    "userId": "U001",
    "userName": "张三",
    "userAvatar": "https://avatar.url/zhangsan.png",
    "userDepartment": "技术部",
    "module": "users",
    "moduleName": "用户管理",
    "operation": "create",
    "operationName": "创建用户",
    "description": "创建了新用户：李四（lisi@example.com）",
    "level": "info",
    "ipAddress": "192.168.1.100",
    "location": "北京",
    "device": "Chrome 120 on Windows 10",
    "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36...",
    "operationTime": "2025-12-19 10:30:00",
    "duration": 125,
    "success": true,
    "requestUrl": "/api/v1/users",
    "requestMethod": "POST",
    "requestHeaders": {
      "Authorization": "Bearer ***",
      "Content-Type": "application/json"
    },
    "requestData": {
      "name": "李四",
      "email": "lisi@example.com",
      "phone": "13900139000",
      "department": "产品部"
    },
    "responseStatus": 200,
    "responseData": {
      "id": "U100",
      "name": "李四",
      "status": "success"
    },
    "changes": [
      {
        "field": "status",
        "oldValue": null,
        "newValue": "已激活"
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 4. 导出审计日志
**接口地址**: `POST /api/v1/audit-logs/export`

**请求参数**:
```json
{
  "module": "users",
  "operation": "delete",
  "level": "warning",
  "startDate": "2025-12-01",
  "endDate": "2025-12-19",
  "format": "excel"
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "导出任务已创建",
  "data": {
    "taskId": "EXPORT_001",
    "status": "进行中",
    "createTime": "2025-12-19 11:00:00",
    "estimatedTime": "2分钟"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 5. 获取导出任务状态
**接口地址**: `GET /api/v1/audit-logs/export/{taskId}`

**路径参数**:
- `taskId`: 导出任务ID

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "taskId": "EXPORT_001",
    "status": "完成",
    "progress": 100,
    "totalRecords": 5600,
    "createTime": "2025-12-19 11:00:00",
    "completeTime": "2025-12-19 11:02:00",
    "fileSize": "2.5 MB",
    "downloadUrl": "https://files.example.com/exports/audit-logs-20251219.xlsx",
    "expiryTime": "2025-12-26 11:02:00"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 6. 获取用户操作历史
**接口地址**: `GET /api/v1/audit-logs/user/{userId}`

**路径参数**:
- `userId`: 用户ID

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认20
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**: 同审计日志列表

---

### 7. 获取模块操作统计
**接口地址**: `GET /api/v1/audit-logs/module-stats`

**查询参数**:
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": [
    {
      "module": "users",
      "moduleName": "用户管理",
      "totalOperations": 45000,
      "create": 1200,
      "update": 18000,
      "delete": 300,
      "query": 25500
    },
    {
      "module": "tenants",
      "moduleName": "租户管理",
      "totalOperations": 25000,
      "create": 150,
      "update": 8000,
      "delete": 50,
      "query": 16800
    }
  ],
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 8. 获取敏感操作日志
**接口地址**: `GET /api/v1/audit-logs/sensitive`

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认20
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "total": "1250",
    "list": [
      {
        "id": "LOG_SEN_001",
        "userId": "U001",
        "userName": "张三",
        "module": "users",
        "operation": "delete",
        "description": "删除了用户：王五（wangwu@example.com）",
        "level": "warning",
        "operationTime": "2025-12-19 10:30:00",
        "ipAddress": "192.168.1.100",
        "success": true
      },
      {
        "id": "LOG_SEN_002",
        "userId": "U001",
        "userName": "张三",
        "module": "permissions",
        "operation": "update",
        "description": "修改了角色：系统管理员的权限配置",
        "level": "warning",
        "operationTime": "2025-12-19 10:25:00",
        "ipAddress": "192.168.1.100",
        "success": true
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 9. 获取失败操作日志
**接口地址**: `GET /api/v1/audit-logs/failures`

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认20
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**: 同审计日志列表（仅包含success=false的记录）

---

### 10. 清理审计日志
**接口地址**: `DELETE /api/v1/audit-logs/cleanup`

**请求参数**:
```json
{
  "beforeDate": "2025-06-01",
  "level": "info"
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "清理完成",
  "data": {
    "deletedCount": 50000,
    "beforeDate": "2025-06-01",
    "level": "info",
    "cleanupTime": "2025-12-19 11:00:00"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 11. 获取审计日志保留策略
**接口地址**: `GET /api/v1/audit-logs/retention-policy`

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "tenantId": "1",
    "createdBy": "1000001",
    "creator": "系统管理员",
    "createdDate": "2024-01-15 10:00:00",
    "modifiedBy": "1000001",
    "modifier": "系统管理员",
    "modifiedDate": "2025-12-03 14:30:00",
    "id": "RETENTION_001",
    "infoRetentionDays": 90,
    "warningRetentionDays": 180,
    "errorRetentionDays": 365,
    "autoCleanupEnabled": true,
    "cleanupSchedule": "0 2 * * *"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 12. 更新审计日志保留策略
**接口地址**: `PUT /api/v1/audit-logs/retention-policy`

**请求参数**:
```json
{
  "infoRetentionDays": 60,
  "warningRetentionDays": 180,
  "errorRetentionDays": 365,
  "autoCleanupEnabled": true,
  "cleanupSchedule": "0 3 * * *"
}
```

**响应数据**: 同审计日志保留策略

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| AUDIT_001 | 审计日志不存在 |
| AUDIT_002 | 导出任务不存在 |
| AUDIT_003 | 导出格式不支持 |
| AUDIT_004 | 日期范围过大 |
| AUDIT_005 | 清理操作失败 |
