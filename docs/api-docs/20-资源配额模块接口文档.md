# 资源配额模块 - 后端API接口文档

## 基础信息
- **模块名称**: 资源配额
- **模块路径**: `/api/v1/quotas`
- **负责功能**: 租户资源配额管理、使用情况监控、配额告警

---

## 接口列表

### 1. 获取资源配额概览
**接口地址**: `GET /api/v1/quotas/overview`

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "totalTenants": 48,
    "tenantsOverQuota": 3,
    "tenantsNearQuota": 8,
    "totalUsersQuota": 5000,
    "totalUsersUsed": 3245,
    "totalStorageQuota": "2 TB",
    "totalStorageUsed": "1.2 TB"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

## 租户配额管理

### 2. 获取租户配额列表（分页）
**接口地址**: `GET /api/v1/quotas/tenants`

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认10
- `keyword`: 搜索关键词（租户名称）
- `status`: 状态筛选（正常、接近上限、已超限）

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "total": "48",
    "list": [
      {
        "tenantId": "1",
        "createdBy": "1000001",
        "creator": "系统管理员",
        "createdDate": "2024-01-15 10:00:00",
        "modifiedBy": "1000001",
        "modifier": "系统管理员",
        "modifiedDate": "2025-12-03 14:30:00",
        "id": "QUOTA_T001",
        "tenantId": "T001",
        "tenantName": "TechFlow Inc",
        "users": {
          "quota": 500,
          "used": 328,
          "usagePercent": 65.6,
          "available": 172
        },
        "storage": {
          "quota": "100 GB",
          "used": "45 GB",
          "usagePercent": 45.0,
          "available": "55 GB"
        },
        "applications": {
          "quota": 20,
          "used": 8,
          "usagePercent": 40.0,
          "available": 12
        },
        "apiCalls": {
          "quota": 1000000,
          "used": 125000,
          "usagePercent": 12.5,
          "available": 875000
        },
        "status": "正常"
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 3. 获取租户配额详情
**接口地址**: `GET /api/v1/quotas/tenants/{tenantId}`

**路径参数**:
- `tenantId`: 租户ID

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "tenantId": "T001",
    "tenantName": "TechFlow Inc",
    "users": {
      "quota": 500,
      "used": 328,
      "usagePercent": 65.6,
      "available": 172,
      "trend": [
        {
          "date": "2025-12-12",
          "count": 300
        },
        {
          "date": "2025-12-13",
          "count": 310
        }
      ]
    },
    "storage": {
      "quota": "100 GB",
      "used": "45 GB",
      "usagePercent": 45.0,
      "available": "55 GB",
      "breakdown": {
        "documents": "25 GB",
        "databases": "15 GB",
        "attachments": "5 GB"
      },
      "trend": [
        {
          "date": "2025-12-12",
          "size": "43 GB"
        },
        {
          "date": "2025-12-13",
          "size": "44 GB"
        }
      ]
    },
    "applications": {
      "quota": 20,
      "used": 8,
      "usagePercent": 40.0,
      "available": 12,
      "list": [
        {
          "name": "AngusAI",
          "enabled": true
        },
        {
          "name": "AngusGM",
          "enabled": true
        }
      ]
    },
    "apiCalls": {
      "quota": 1000000,
      "used": 125000,
      "usagePercent": 12.5,
      "available": 875000,
      "dailyAverage": 4500,
      "trend": [
        {
          "date": "2025-12-12",
          "count": 18000
        },
        {
          "date": "2025-12-13",
          "count": 17500
        }
      ]
    },
    "status": "正常"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 4. 更新租户配额
**接口地址**: `PUT /api/v1/quotas/tenants/{tenantId}`

**路径参数**:
- `tenantId`: 租户ID

**请求参数**:
```json
{
  "users": {
    "quota": 1000
  },
  "storage": {
    "quota": "200 GB"
  },
  "applications": {
    "quota": 30
  },
  "apiCalls": {
    "quota": 5000000
  }
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "配额更新成功",
  "data": {
    "tenantId": "T001",
    "tenantName": "TechFlow Inc",
    "users": {
      "quota": 1000,
      "used": 328,
      "usagePercent": 32.8,
      "available": 672
    },
    "storage": {
      "quota": "200 GB",
      "used": "45 GB",
      "usagePercent": 22.5,
      "available": "155 GB"
    },
    "applications": {
      "quota": 30,
      "used": 8,
      "usagePercent": 26.7,
      "available": 22
    },
    "apiCalls": {
      "quota": 5000000,
      "used": 125000,
      "usagePercent": 2.5,
      "available": 4875000
    },
    "modifiedDate": "2025-12-19 11:00:00"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

## 配额模板管理

### 5. 获取配额模板列表
**接口地址**: `GET /api/v1/quotas/templates`

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": [
    {
      "tenantId": "1",
      "createdBy": "1000001",
      "creator": "系统管理员",
      "createdDate": "2024-01-15 10:00:00",
      "modifiedBy": "1000001",
      "modifier": "系统管理员",
      "modifiedDate": "2025-12-03 14:30:00",
      "id": "TMPL_001",
      "name": "基础版",
      "description": "适合小型团队使用",
      "users": 50,
      "storage": "10 GB",
      "applications": 5,
      "apiCalls": 100000,
      "price": 99,
      "isDefault": false
    },
    {
      "tenantId": "1",
      "createdBy": "1000001",
      "creator": "系统管理员",
      "createdDate": "2024-01-15 10:00:00",
      "modifiedBy": "1000001",
      "modifier": "系统管理员",
      "modifiedDate": "2025-12-03 14:30:00",
      "id": "TMPL_002",
      "name": "标准版",
      "description": "适合中型企业使用",
      "users": 200,
      "storage": "50 GB",
      "applications": 10,
      "apiCalls": 500000,
      "price": 499,
      "isDefault": true
    },
    {
      "tenantId": "1",
      "createdBy": "1000001",
      "creator": "系统管理员",
      "createdDate": "2024-01-15 10:00:00",
      "modifiedBy": "1000001",
      "modifier": "系统管理员",
      "modifiedDate": "2025-12-03 14:30:00",
      "id": "TMPL_003",
      "name": "企业版",
      "description": "适合大型企业使用",
      "users": 1000,
      "storage": "200 GB",
      "applications": 30,
      "apiCalls": 5000000,
      "price": 1999,
      "isDefault": false
    }
  ],
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 6. 创建配额模板
**接口地址**: `POST /api/v1/quotas/templates`

**请求参数**:
```json
{
  "name": "专业版",
  "description": "适合专业团队使用",
  "users": 500,
  "storage": "100 GB",
  "applications": 20,
  "apiCalls": 2000000,
  "price": 999
}
```

**响应数据**: 同配额模板列表中的单项数据

---

### 7. 应用模板到租户
**接口地址**: `POST /api/v1/quotas/tenants/{tenantId}/apply-template`

**路径参数**:
- `tenantId`: 租户ID

**请求参数**:
```json
{
  "templateId": "TMPL_002"
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "模板应用成功",
  "data": {
    "tenantId": "T001",
    "templateId": "TMPL_002",
    "templateName": "标准版",
    "appliedDate": "2025-12-19 11:00:00"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

## 配额告警

### 8. 获取配额告警规则
**接口地址**: `GET /api/v1/quotas/alert-rules`

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "tenantId": "1",
    "createdBy": "1000001",
    "creator": "系统管理员",
    "createdDate": "2024-01-15 10:00:00",
    "modifiedBy": "1000001",
    "modifier": "系统管理员",
    "modifiedDate": "2025-12-03 14:30:00",
    "id": "ALERT_RULE_001",
    "users": {
      "warningThreshold": 80,
      "criticalThreshold": 95,
      "enabled": true
    },
    "storage": {
      "warningThreshold": 80,
      "criticalThreshold": 95,
      "enabled": true
    },
    "applications": {
      "warningThreshold": 80,
      "criticalThreshold": 95,
      "enabled": true
    },
    "apiCalls": {
      "warningThreshold": 80,
      "criticalThreshold": 95,
      "enabled": true
    },
    "notifyChannels": ["email", "sms"]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 9. 更新配额告警规则
**接口地址**: `PUT /api/v1/quotas/alert-rules`

**请求参数**:
```json
{
  "users": {
    "warningThreshold": 75,
    "criticalThreshold": 90,
    "enabled": true
  },
  "storage": {
    "warningThreshold": 75,
    "criticalThreshold": 90,
    "enabled": true
  },
  "notifyChannels": ["email", "sms", "slack"]
}
```

**响应数据**: 同配额告警规则

---

### 10. 获取配额告警记录（分页）
**接口地址**: `GET /api/v1/quotas/alerts`

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认10
- `tenantId`: 租户ID筛选
- `resourceType`: 资源类型（users、storage、applications、apiCalls）
- `level`: 告警级别（warning、critical）
- `status`: 状态筛选（待处理、已处理）

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "total": "25",
    "list": [
      {
        "tenantId": "1",
        "createdBy": "SYSTEM",
        "creator": "系统",
        "createdDate": "2025-12-19 10:30:00",
        "modifiedBy": "SYSTEM",
        "modifier": "系统",
        "modifiedDate": "2025-12-19 10:30:00",
        "id": "QUOTA_ALERT_001",
        "tenantId": "T003",
        "tenantName": "CloudNet Systems",
        "resourceType": "storage",
        "resourceName": "存储空间",
        "level": "critical",
        "quota": "100 GB",
        "used": "96 GB",
        "usagePercent": 96.0,
        "threshold": 95,
        "message": "存储空间使用率已达96%，超过临界阈值95%",
        "status": "待处理",
        "alertTime": "2025-12-19 10:30:00",
        "notified": true
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 11. 处理配额告警
**接口地址**: `PATCH /api/v1/quotas/alerts/{id}/handle`

**路径参数**:
- `id`: 告警ID

**请求参数**:
```json
{
  "status": "已处理",
  "handleNote": "已为租户扩容至200GB"
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "处理成功",
  "data": {
    "id": "QUOTA_ALERT_001",
    "status": "已处理",
    "handledBy": "1000001",
    "handledTime": "2025-12-19 11:00:00",
    "handleNote": "已为租户扩容至200GB"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| QUOTA_001 | 配额模板不存在 |
| QUOTA_002 | 租户配额不存在 |
| QUOTA_003 | 配额已超限 |
| QUOTA_004 | 配额不能小于当前使用量 |
| QUOTA_005 | 告警规则不存在 |
