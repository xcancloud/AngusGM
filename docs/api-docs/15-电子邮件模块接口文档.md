# 电子邮件模块 - 后端API接口文档

## 基础信息
- **模块名称**: 电子邮件
- **模块路径**: `/api/v1/email`
- **负责功能**: 邮件发送、模板管理、发送记录查询

---

## 接口列表

### 1. 获取邮件统计数据
**接口地址**: `GET /api/v1/email/stats`

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "totalSent": 8560,
    "successCount": 8420,
    "failedCount": 140,
    "todaySent": 89,
    "thisMonthSent": 3200,
    "openRate": 45.6,
    "clickRate": 12.3
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 2. 获取邮件记录列表（分页）
**接口地址**: `GET /api/v1/email/records`

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认10
- `keyword`: 搜索关键词（收件人、主题）
- `status`: 状态筛选（成功、失败、待发送）
- `templateId`: 模板ID筛选
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "total": "8560",
    "list": [
      {
        "tenantId": "1",
        "createdBy": "SYSTEM",
        "creator": "系统自动",
        "createdDate": "2025-12-19 10:30:00",
        "modifiedBy": "SYSTEM",
        "modifier": "系统自动",
        "modifiedDate": "2025-12-19 10:30:05",
        "id": "EMAIL001",
        "to": "user@example.com",
        "cc": null,
        "bcc": null,
        "subject": "【AngusGM】账号登录验证码",
        "content": "<p>您的验证码是：<strong>123456</strong>，5分钟内有效。</p>",
        "templateId": "ETPL001",
        "templateName": "登录验证码邮件",
        "status": "成功",
        "sentTime": "2025-12-19 10:30:00",
        "deliveredTime": "2025-12-19 10:30:05",
        "openedTime": "2025-12-19 10:35:00",
        "clickedTime": null,
        "attachments": [],
        "provider": "阿里云邮件推送"
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 3. 发送单封邮件
**接口地址**: `POST /api/v1/email/send`

**请求参数**:
```json
{
  "to": "user@example.com",
  "cc": "manager@example.com",
  "bcc": null,
  "templateId": "ETPL001",
  "params": {
    "code": "123456",
    "name": "张三"
  },
  "attachments": []
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "发送成功",
  "data": {
    "tenantId": "1",
    "createdBy": "1000001",
    "creator": "柳小龙",
    "createdDate": "2025-12-19 10:30:00",
    "modifiedBy": "1000001",
    "modifier": "柳小龙",
    "modifiedDate": "2025-12-19 10:30:05",
    "id": "EMAIL100",
    "to": "user@example.com",
    "subject": "【AngusGM】账号登录验证码",
    "templateId": "ETPL001",
    "status": "成功",
    "sentTime": "2025-12-19 10:30:00",
    "messageId": "email-abc123"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 4. 批量发送邮件
**接口地址**: `POST /api/v1/email/send-batch`

**请求参数**:
```json
{
  "to": ["user1@example.com", "user2@example.com", "user3@example.com"],
  "templateId": "ETPL002",
  "params": {
    "event": "系统维护",
    "time": "2025-12-20 02:00"
  }
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "批量发送成功",
  "data": {
    "totalCount": 3,
    "successCount": 3,
    "failedCount": 0,
    "results": [
      {
        "to": "user1@example.com",
        "status": "成功",
        "messageId": "email-abc123"
      },
      {
        "to": "user2@example.com",
        "status": "成功",
        "messageId": "email-abc124"
      },
      {
        "to": "user3@example.com",
        "status": "成功",
        "messageId": "email-abc125"
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 5. 发送自定义邮件（不使用模板）
**接口地址**: `POST /api/v1/email/send-custom`

**请求参数**:
```json
{
  "to": "user@example.com",
  "cc": null,
  "bcc": null,
  "subject": "重要通知",
  "content": "<h1>系统升级通知</h1><p>系统将于明日进行升级...</p>",
  "contentType": "html",
  "attachments": [
    {
      "fileName": "upgrade_plan.pdf",
      "fileUrl": "https://files.example.com/upgrade_plan.pdf"
    }
  ]
}
```

**响应数据**: 同发送单封邮件

---

### 6. 获取邮件模板列表（分页）
**接口地址**: `GET /api/v1/email/templates`

**查询参数**:
- `page`: 页码，默认1
- `size`: 每页大小，默认10
- `keyword`: 搜索关键词
- `status`: 状态筛选（已启用、已禁用）
- `type`: 类型筛选（系统邮件、营销邮件、通知邮件）

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "total": "35",
    "list": [
      {
        "tenantId": "1",
        "createdBy": "1000001",
        "creator": "系统管理员",
        "createdDate": "2024-01-15 10:00:00",
        "modifiedBy": "1000001",
        "modifier": "系统管理员",
        "modifiedDate": "2025-12-03 14:30:00",
        "id": "ETPL001",
        "name": "登录验证码邮件",
        "code": "LOGIN_VERIFY_CODE",
        "type": "系统邮件",
        "subject": "【AngusGM】账号登录验证码",
        "content": "<div><p>尊敬的{name}，</p><p>您的验证码是：<strong>{code}</strong>，5分钟内有效。</p></div>",
        "params": ["name", "code"],
        "status": "已启用",
        "usageCount": 856,
        "openRate": 78.5,
        "clickRate": 15.2
      }
    ]
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 7. 创建邮件模板
**接口地址**: `POST /api/v1/email/templates`

**请求参数**:
```json
{
  "name": "系统通知邮件",
  "code": "SYSTEM_NOTIFY",
  "type": "通知邮件",
  "subject": "【AngusGM】{event}通知",
  "content": "<div><p>尊敬的{name}，</p><p>{event}将于{time}进行，请知悉。</p><p>AngusGM团队</p></div>",
  "params": ["name", "event", "time"]
}
```

**响应数据**: 同邮件模板列表中的单项数据

---

### 8. 更新邮件模板
**接口地址**: `PUT /api/v1/email/templates/{id}`

**路径参数**:
- `id`: 模板ID

**请求参数**: 同创建邮件模板

**响应数据**: 同邮件模板列表中的单项数据

---

### 9. 删除邮件模板
**接口地址**: `DELETE /api/v1/email/templates/{id}`

**路径参数**:
- `id`: 模板ID

**响应**: HTTP 204 No Content（无响应体）

---

### 10. 启用/禁用邮件模板
**接口地址**: `PATCH /api/v1/email/templates/{id}/status`

**路径参数**:
- `id`: 模板ID

**请求参数**:
```json
{
  "status": "已禁用"
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "状态更新成功",
  "data": {
    "id": "ETPL001",
    "status": "已禁用",
    "modifiedDate": "2025-12-19 11:00:00"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 11. 获取SMTP配置
**接口地址**: `GET /api/v1/email/smtp`

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "tenantId": "1",
    "createdBy": "1000001",
    "creator": "系统管理员",
    "createdDate": "2024-01-15 10:00:00",
    "modifiedBy": "1000001",
    "modifier": "系统管理员",
    "modifiedDate": "2025-12-03 14:30:00",
    "id": "SMTP001",
    "host": "smtp.exmail.qq.com",
    "port": 465,
    "username": "notify@angusgm.com",
    "password": "******",
    "fromName": "AngusGM系统",
    "fromEmail": "notify@angusgm.com",
    "useSsl": true,
    "isDefault": true
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 12. 更新SMTP配置
**接口地址**: `PUT /api/v1/email/smtp`

**请求参数**:
```json
{
  "host": "smtp.exmail.qq.com",
  "port": 465,
  "username": "notify@angusgm.com",
  "password": "newpassword",
  "fromName": "AngusGM系统",
  "fromEmail": "notify@angusgm.com",
  "useSsl": true
}
```

**响应数据**: 同SMTP配置

---

### 13. 测试SMTP连接
**接口地址**: `POST /api/v1/email/smtp/test`

**请求参数**:
```json
{
  "host": "smtp.exmail.qq.com",
  "port": 465,
  "username": "notify@angusgm.com",
  "password": "password",
  "useSsl": true
}
```

**响应数据**:
```json
{
  "code": "S",
  "message": "连接测试成功",
  "data": {
    "connected": true,
    "testTime": "2025-12-19 11:00:00",
    "message": "SMTP连接正常"
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

### 14. 获取邮件打开/点击统计
**接口地址**: `GET /api/v1/email/{id}/stats`

**路径参数**:
- `id`: 邮件记录ID

**响应数据**:
```json
{
  "code": "S",
  "message": "成功",
  "data": {
    "emailId": "EMAIL001",
    "subject": "【AngusGM】账号登录验证码",
    "sentTime": "2025-12-19 10:30:00",
    "deliveredTime": "2025-12-19 10:30:05",
    "opened": true,
    "openedTime": "2025-12-19 10:35:00",
    "openCount": 3,
    "clicked": false,
    "clickCount": 0,
    "bounced": false,
    "complained": false
  },
  "timestamp": "1763958969885",
  "extensions": {}
}
```

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| EMAIL_001 | 邮件模板不存在 |
| EMAIL_002 | 邮箱地址格式错误 |
| EMAIL_003 | SMTP配置错误 |
| EMAIL_004 | 发送频率过快 |
| EMAIL_005 | 附件大小超过限制 |
| EMAIL_006 | 模板参数缺失 |
| EMAIL_007 | SMTP连接失败 |
